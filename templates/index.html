<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Proxima+Nova&display=swap" rel="stylesheet">
</head>
<body>
  <div id="chatHistory">
    {% for entry in chat_history %}
      {% if entry.role == 'user' %}
        <p>You: {{ entry.content }}</p>
      {% elif entry.role == 'assistant' %}
        <p>Bot: {{ entry.content }}</p>
      {% endif %}
    {% endfor %}
  </div>
  <form onsubmit="submitForm(event);">
    <input id="prompt" required>
    <input type="submit" value="Submit">
  </form>
  <button onclick="clearChatHistory()">Clear Chat History</button> <!-- Add this button -->


  <script>
    function appendPromptToHistory(prompt) {
      var chatHistory = document.getElementById('chatHistory');
      var userText = '<p>You: ' + prompt + '</p>';
      chatHistory.innerHTML += userText;
      localStorage.setItem("chat", chatHistory.innerHTML);
    }

    function displayBotResponse(response) {
      if (response.choices) { // Modify this line to check if response.choices is defined
        var botText = '<p>Bot: ' + response.choices[0].message.content + '</p>';
        var chatHistory = document.getElementById('chatHistory');
        chatHistory.innerHTML += botText;
        localStorage.setItem("chat", chatHistory.innerHTML);
      } 
    }

    function submitForm(event) {
      event.preventDefault();
      var promptInput = document.getElementById('prompt');
      var prompt = promptInput.value;
      appendPromptToHistory(prompt);
      promptInput.value = "";

      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/", true);
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xhr.onreadystatechange = function() {
        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
          var response = JSON.parse(xhr.responseText);
          displayBotResponse(response);
        }
      };
      xhr.send("prompt=" + encodeURIComponent(prompt));
    }

    function clearChatHistory() {  // Add this method
      var chatHistory = document.getElementById('chatHistory');
      chatHistory.innerHTML = "";
      localStorage.removeItem("chat");
    }

    window.onload = function() {
      var chatHistory = document.getElementById('chatHistory');
      var oldChat = localStorage.getItem("chat") || "";
      chatHistory.innerHTML = oldChat;
    };
  </script>
</body>
</html>